---
title: "GSEA overlap"
format: html
editor: visual
---

==================================================================================================

# GSEA for trisomy data

Author: Carlo Zanetti

This script performs GSEA to identify biological pathways enriched in the differential expression lists generated by edgeR. It uses the fgsea package.

## Workflow overview

1\. Data Loading: Imports DE tables (CSV) from the edgeR step.

2\. Gene Set Prep: Loads pathways from multiple sources (Mancuso, Magda, GO/KEGG).

3\. Ranking: Ranks genes by Log Fold Change (LogFC) for every comparison.

4\. Analysis Loop: Runs GSEA for every combination of \[Comparison x Gene Set Database\].

5\. Visualization:

-   Generates summary bar plots of top normalized enrichment scores (NES).
-   Generates specific enrichment plots (mountain plots) for key pathways.

==================================================================================================

```{r}
setwd("~/home/shared/zanettc/emily_transcriptomics")
library(SingleCellExperiment)
library(edgeR)
library(limma)
library(scuttle)
library(Seurat)
library(qs2)
library(ggrepel)
library(ggplot2)
library(stringr)
library(glue)
library(dplyr)
library(msigdbr)
library(fgsea)
library(viridis)
library(readxl)
```

## Set directories

```{r}
run_num <- "run7"
out_dir <- file.path("output", "jan_data", run_num, "edgeR")
graphs_dir <- file.path(out_dir, "graphs")
objects_dir <- file.path(out_dir, "objects")

dir.create(graphs_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(objects_dir, recursive = TRUE, showWarnings = FALSE)
```

## Read in DE data

```{r}
seurat <- qs_read(glue("output/jan_data/{run_num}/objects/prelabelled_integrated_rpca.qs2"))
tab_nlgf <- read.csv(file.path(objects_dir, "NLGF_A_vs_B.csv"))
tab_happ <- read.csv(file.path(objects_dir, "hAPP_A_vs_B.csv"))
tab_a <- read.csv(file.path(objects_dir, "A_NLGF_vs_hAPP.csv"))
tab_b <- read.csv(file.path(objects_dir, "B_NLGF_vs_hAPP.csv"))
```

## Define helper functions

```{r}
# A. Create Rank Vector
create_rank_vector <- function(de_tab, gene_col = "X", stat_col = "logFC") {
  if (!all(c(gene_col, stat_col) %in% names(de_tab))) {
    stop(glue("Columns '{gene_col}' or '{stat_col}' not found in dataframe."))
  }
  ranks <- de_tab[[stat_col]]
  names(ranks) <- de_tab[[gene_col]]
  # Remove NAs
  ranks <- ranks[!is.na(ranks) & !is.na(names(ranks))]
  return(sort(ranks, decreasing = TRUE))
}

# B. Core GSEA & Plotting Function
run_gsea_analysis <- function(ranks, 
                              comparison_name, 
                              geneset_name,    
                              pathways, 
                              base_objects_dir, 
                              base_graphs_dir,  
                              group_A_label = "Group A",
                              group_B_label = "Group B",
                              color_A = "#EE7733",
                              color_B = "#33BBEE") {
  
  message(glue("Running GSEA | Set: {geneset_name} | Comp: {comparison_name}"))
  
  # --- 1. Dynamic Directory Creation ---
  current_objects_dir <- file.path(base_objects_dir, "GSEA_Analysis", comparison_name)
  current_graphs_dir  <- file.path(base_graphs_dir, "GSEA_Analysis", comparison_name)
  
  dir.create(current_objects_dir, recursive = TRUE, showWarnings = FALSE)
  dir.create(current_graphs_dir, recursive = TRUE, showWarnings = FALSE)
  
  # --- 2. Run FGSEA ---
  set.seed(42)
  fgsea_res <- fgsea(
    pathways = pathways,
    stats    = ranks,
    minSize  = 15,
    maxSize  = 3000,
    nproc    = 1 
  )
  
  if (nrow(fgsea_res) == 0) {
    warning(glue("No significant pathways for {geneset_name} in {comparison_name}"))
    return(NULL)
  }
  
  # --- 3. Save CSV ---
  fgsea_res_tidy <- fgsea_res %>%
    as_tibble() %>%
    mutate(leadingEdge = sapply(leadingEdge, paste, collapse = ",")) %>%
    # Clean Pathway Names
    mutate(pathway = gsub("_geneset", "", pathway)) %>% 
    arrange(padj)
  
  csv_name <- glue("Table_{geneset_name}.csv")
  write.csv(fgsea_res_tidy, file.path(current_objects_dir, csv_name), row.names = FALSE)
  
  # --- 4. Plotting ---
  top_gsea <- fgsea_res_tidy %>%
    arrange(desc(NES)) %>%
    slice_head(n = 10) %>%
    bind_rows(fgsea_res_tidy %>% arrange(NES) %>% slice_head(n = 10)) %>%
    distinct(pathway, .keep_all = TRUE) %>%
    mutate(
      sig_label = case_when(
        padj < 0.001 ~ "***",
        padj < 0.01  ~ "**",
        padj < 0.05  ~ "*",
        TRUE         ~ ""
      ),
      fill_group = ifelse(NES > 0, group_A_label, group_B_label),
      pathway = factor(pathway, levels = unique(pathway[order(NES)]))
    )
  
  if (nrow(top_gsea) == 0) return(fgsea_res_tidy)
  
  # Hard axis limit
  axis_zoom <- 3.5 
  
  plot_title <- glue("{sub('_.*', '', comparison_name)} ({geneset_name})")
  
  p <- ggplot(top_gsea, aes(x = NES, y = pathway, fill = fill_group)) +
    
    # 1. Add faint vertical grid lines BEHIND bars (using geom_vline or theme)
    # The cleanest way is usually via theme, but here is the setup:
    geom_col(width = 0.7) +
    
    geom_text(aes(label = sig_label, hjust = ifelse(NES > 0, 1.2, -0.2)), 
              color = "white", size = 5, vjust = 0.75, fontface = "bold") +
    
    scale_fill_manual(values = setNames(c(color_A, color_B), c(group_A_label, group_B_label))) +
    
    # --- AXIS CONFIGURATION ---
    scale_x_continuous(
      # Create breaks at every 0.5 interval
      breaks = seq(-axis_zoom, axis_zoom, 0.5),
      # Custom label function: If x is an integer, show x. Else show empty string.
      labels = function(x) ifelse(x %% 1 == 0, x, "")
    ) + 
    
    labs(x = "NES", y = NULL, title = plot_title) +
    theme_bw(base_size = 14) +
    
    theme(
      # Turn ON vertical grid lines (major.x), make them faint grey
      panel.grid.major.x = element_line(color = "grey92", linewidth = 0.5),
      # Turn OFF horizontal grid lines (major.y) and minor grids
      panel.grid.major.y = element_blank(),
      panel.grid.minor   = element_blank(),
      
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.5),
      legend.position = "none",
      
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16, margin = margin(b = 40)),
      
      # Adjust top margin (t) slightly to ensure title isn't cut off at the very top of PDF
      plot.margin = margin(t = 20, r = 10, b = 10, l = 10, unit = "pt")
    ) +
    
    # Annotations
    annotate("text", x = -axis_zoom/2, y = Inf, 
             label = glue("^ {group_B_label}"), color = color_B, size = 5, fontface = "bold", vjust = -1.0) +
    annotate("text", x = axis_zoom/2, y = Inf, 
             label = glue("^ {group_A_label}"), color = color_A, size = 5, fontface = "bold", vjust = -1.0) +
    
    coord_cartesian(xlim = c(-axis_zoom, axis_zoom), clip = "off")
  
  # --- 5. Save Plot ---
  plot_name <- glue("Barplot_{geneset_name}.pdf")
  
  # Calculate Height: Base 2 inches + 0.3 inches per bar
  dynamic_height <- 2 + (nrow(top_gsea) * 0.3)
  
  # NEW: Calculate Width based on the longest label text
  # 1. Find the longest pathway name (number of characters)
  max_len <- max(nchar(as.character(top_gsea$pathway)))
  
  # 2. Set width: 5 inches for the plot bars + roughly 0.12 inches per character of text
  #    Examples: 
  #    - Short names (10 chars) -> 5 + 1.2 = ~6.2 inches wide
  #    - Long GO terms (60 chars) -> 5 + 7.2 = ~12.2 inches wide
  dynamic_width <- 5 + (max_len * 0.12)
  
  ggsave(filename = file.path(current_graphs_dir, plot_name), 
         plot = p, 
         width = dynamic_width, 
         height = dynamic_height,
         limitsize = FALSE) # Allows creating very large PDFs if needed
  
  return(fgsea_res_tidy)
}
```

## Load data

```{r}
# ==============================================================================
# 2. CONFIG & DATA LOADING
# ==============================================================================

# --- A. General Settings ---
GLOBAL_CONFIG <- list(
  # NOTE: Fixed missing comma below
  output_dir = file.path(out_dir, "GSEA_Results_Master"), 
  group_A    = "Group A",
  group_B    = "Group B",
  col_A      = "#EE7733",
  col_B      = "#33BBEE"
)

# --- B. Load Gene Sets ---

# 1. Mancuso (TXT files)
mancuso_dir <- "../Mancuso2024_genesets"
mancuso_files <- list.files(path = mancuso_dir, pattern = "\\.txt$")
mancuso_list <- lapply(mancuso_files, function(x) {
  scan(file.path(mancuso_dir, x), what = "character", quiet = TRUE)
})
names(mancuso_list) <- gsub(".txt$", "", mancuso_files)

# 2. Magda (Excel)
module_data <- read_excel("../external_data/magda_modules.xlsx")
magda_list <- lapply(module_data, function(x) unique(na.omit(as.character(x))))
magda_list <- magda_list[sapply(magda_list, length) > 0] 

#3. GO / KEGG
go_pathways <- gmtPathways("../GO_human_all_genesets.gmt")
kegg_df <- msigdbr(species = "Homo sapiens", category = "C2", subcategory = "CP:KEGG_MEDICUS")
kegg_list <- split(x = kegg_df$gene_symbol, f = kegg_df$gs_name)
go_kegg_list <- c(go_pathways, kegg_list)


# 3. Master List
gene_sets_master <- list(
  "Mancuso" = mancuso_list,
  "Magda"   = magda_list,
  "GO_KEGG" = go_kegg_list
)

# --- C. Load Ranks ---
# (Ensure tab_happ and tab_nlgf are loaded in your environment)
comparisons_master <- list(
  "hAPP A vs B" = create_rank_vector(tab_happ, "X", "logFC"),
  "NLGF A vs B" = create_rank_vector(tab_nlgf, "X", "logFC"),
  "A NLGF vs A hAPP" = create_rank_vector(tab_a, "X", "logFC"),
  "B NLGF vs B hAPP" = create_rank_vector(tab_b, "X", "logFC")
)
```

## Execution loop

```{r}
purrr::walk2(names(gene_sets_master), gene_sets_master, function(gset_name, gset_pathways) {
  purrr::walk2(comparisons_master, names(comparisons_master), function(ranks, comp_name) {
    
    run_gsea_analysis(
      ranks            = ranks,
      comparison_name  = comp_name,
      geneset_name     = gset_name,     
      pathways         = gset_pathways, 
      base_objects_dir = objects_dir,   # Uses your existing variable
      base_graphs_dir  = graphs_dir,    # Uses your existing variable
      group_A_label    = GLOBAL_CONFIG$group_A,
      group_B_label    = GLOBAL_CONFIG$group_B,
      color_A          = GLOBAL_CONFIG$col_A,
      color_B          = GLOBAL_CONFIG$col_B
    )
    
    gc() # Memory cleanup
  })
})
```

## Specific term plotting

```{r}
#Input specific term here
term_to_plot <- "GOBP_RESPONSE_TO_TYPE_I_INTERFERON"

# 1. Flatten your master gene set list so we can find the term easily
#    (unname prevents "GO_KEGG.TermName" prefixes)
all_pathways_flat <- do.call(c, unname(gene_sets_master))

# 2. Check if the term exists before looping
if (!term_to_plot %in% names(all_pathways_flat)) {
  stop(glue("Could not find pathway '{term_to_plot}' in gene_sets_master."))
}

pathway_genes <- all_pathways_flat[[term_to_plot]]

# 3. Create a specific output folder
specific_graphs_dir <- file.path(graphs_dir, "Specific_Pathway_Plots")
dir.create(specific_graphs_dir, showWarnings = FALSE, recursive = TRUE)

# 4. Loop and Plot
purrr::walk2(comparisons_master, names(comparisons_master), function(ranks, comp_name) {
  
  message(glue("Plotting {term_to_plot} for {comp_name}..."))
  
  # Generate the GSEA enrichment plot
  gsea_plot <- plotEnrichment(pathway_genes, ranks) +
    labs(
      title = term_to_plot,
      subtitle = glue("Comparison: {comp_name}"),
      x = "Rank",
      y = "Enrichment Score"
    ) +
    theme_bw(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5, color = "grey40"),
      panel.grid = element_blank()
    )
  
  # Save
  ggsave(
    filename = file.path(specific_graphs_dir, glue("{term_to_plot}_{comp_name}.pdf")),
    plot = gsea_plot,
    width = 8, 
    height = 5
  )
})
```

# Combined GSEA plots

## Define function

```{r}
plot_combined_gsea <- function(pathway_name, rank_list, pathways_obj, graphs_dir) {
  
  # --- A. Sanitize Filename ---
  safe_pathway_name <- gsub("[[:punct:]]", "_", pathway_name)
  
  # --- B. Check if pathway exists ---
  if (!pathway_name %in% names(pathways_obj)) {
    warning(glue("Pathway '{pathway_name}' not found in the provided pathway object."))
    return(NULL)
  }
  
  gene_set <- pathways_obj[[pathway_name]]
  plot_data_list <- list()
  
  # --- C. Loop through comparisons ---
  for (comp_name in names(rank_list)) {
    
    ranks <- rank_list[[comp_name]]
    
    # Generate the standard fgsea plot object
    # Note: We suppress messages to avoid "calibrating stats" spam
    g <- suppressMessages(plotEnrichment(gene_set, ranks))
    
    # Extract the data frame (columns are typically 'rank' and 'ES')
    df <- g$data
    df$Comparison <- comp_name 
    
    plot_data_list[[comp_name]] <- df
  }
  
  # --- D. Combine data ---
  combined_df <- bind_rows(plot_data_list)
  
  # --- E. Plot ---
  p <- ggplot(combined_df, aes(x = rank, y = ES, color = Comparison)) +
    geom_line(linewidth = 1.2, alpha = 0.8) +
    
    # Add zero line for reference
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey60") +
    
    labs(
      title = pathway_name,
      x = "Gene Rank",
      y = "Enrichment Score"
    ) +
    
    # Use distinct colors for the different comparisons (hAPP vs NLGF)
    scale_color_brewer(palette = "Set1") +
    
    theme_bw(base_size = 14) +
    theme(
      legend.position = "bottom",
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      panel.grid.minor = element_blank()
    )
  
  # --- F. Save ---
  # Create a subfolder for these combined plots
  combined_out_dir <- file.path(graphs_dir, "Combined_GSEA_Plots")
  dir.create(combined_out_dir, showWarnings = FALSE, recursive = TRUE)
  
  file_name <- file.path(combined_out_dir, glue("{safe_pathway_name}_Combined.pdf"))
  
  ggsave(filename = file_name, plot = p, width = 8, height = 6)
  
  return(p)
}
```

## Specific term plotting

```{r}
# Define the term you want
term_to_plot <- "GOCC_CYTOSOLIC_RIBOSOME"

# 1. Flatten the master list so we can search all pathways at once
all_pathways_flat <- do.call(c, unname(gene_sets_master))

# 2. Run the function using your existing 'comparisons_master'
combined_plot <- plot_combined_gsea(
  pathway_name = term_to_plot,
  rank_list    = comparisons_master,  # Uses your hAPP and NLGF ranks
  pathways_obj = all_pathways_flat,   # Uses the flattened list
  graphs_dir   = graphs_dir
)

# 3. View
print(combined_plot)
```
